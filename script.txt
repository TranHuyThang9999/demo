--DROP DATABASE QuanLySinhVien
CREATE DATABASE QuanLySinhVien
GO
use QuanLySinhVien
GO

CREATE TABLE SinhVien
	(
	MaSV char(4)not null PRIMARY KEY,
	TenSV nvarchar(30) not null,
	QueQuan nvarchar(50) not null,
	)
	GO
CREATE TABLE MonHoc
	(
	MaMon char(4) not null PRIMARY KEY,
	TenMon nvarchar(50)not null,
	ThoiGianHoc nvarchar(40),
	HocPhi decimal(8,2)
	)
	GO
CREATE TABLE DangKy
	(
	MaSV char(4) not null REFERENCES	SinhVien(MaSV),
	MaMon char(4) not null REFERENCES MonHoc(MaMon)
	PRIMARY KEY(MaSV, MaMon),
	NgayBatDau datetime not null,
	NgayKetThuc datetime,
	)
	GO
--cau 2
INSERT INTO SinhVien VALUES ('S001', N'Trần Thanh Tùng', N'Đông Anh - Hà Nội')
INSERT INTO SinhVien VALUES ('S002', N'Nguyễn Thu Hà',N'TX Hòa Bình - Hòa Bình' )
INSERT INTO SinhVien VALUES ('S003',N'Lê Ngọc Huyền',N'TX Sơ Tây - Hà Nội')

INSERT INTO MonHoc VALUES ('M001',N'Tin đại cương',N'Học kỳ 1',1000)
INSERT INTO MonHoc VALUES ('M002',N'Lập trình Windows',N'Học kỳ 1',1250)
INSERT INTO MonHoc VALUES ('M003',N'Cơ sở dữ liệu',N'Học kỳ 2',1423)

Insert Into DangKy Values ('S001','M001','2012/09/01','2012/12/08')
INSERT INTO DangKy VALUES ('S001', 'M002','2012/10/12','2012/12/28')
INSERT INTO DangKy VALUES ('S003', 'M003','2013/04/09','2013/07/19')
INSERT INTO DangKy VALUES ('S001', 'M003','2013/09/03','2013/12/30')


--Câu 1 (1.5 điểm):

CREATE PROCEDURE ThongKeDangKy
AS
BEGIN
    SELECT SV.MaSV, SV.TenSV, DK.MaMon, DK.NgayBatDau
    FROM SinhVien SV
    JOIN DangKy DK ON SV.MaSV = DK.MaSV
END 
--Câu 1b: --b) (0.5 điêm): Gọi thực thi thủ tục
EXEC ThongKeDangKy


--Câu 2a:


CREATE PROCEDURE LapBaoCaoDangKy
    @TenSinhVien nvarchar(30),
    @Thang int
AS
BEGIN
    SELECT DK.MaMon, MH.TenMon, DK.NgayBatDau, DK.NgayKetThuc
    FROM SinhVien SV
    JOIN DangKy DK ON SV.MaSV = DK.MaSV
    JOIN MonHoc MH ON DK.MaMon = MH.MaMon
    WHERE SV.TenSV = @TenSinhVien
    AND MONTH(DK.NgayBatDau) = @Thang
END

-- cau 2 b (0.5 điểm):

EXEC LapBaoCaoDangKy @TenSinhVien = N'Trần Thanh Tùng', @Thang = 9

-- cau3 a

CREATE PROCEDURE ThemMoiSinhVien
    @MaSV char(4),
    @TenSV nvarchar(30),
    @QueQuan nvarchar(50),
    @Result int OUTPUT
AS
BEGIN
    SET @Result = 0

    IF NOT EXISTS (SELECT * FROM SinhVien WHERE TenSV = @TenSV)
    BEGIN
        INSERT INTO SinhVien VALUES (@MaSV, @TenSV, @QueQuan)
        SET @Result = 1
    END
    ELSE
    BEGIN
        SET @Result = 0
        PRINT 'Tên sinh viên đã tồn tại.'
    END
END

-- cau 3 b
-- trường hợp 1
DECLARE @Result int
EXEC ThemMoiSinhVien @MaSV = 'S004', @TenSV = N'Nguyễn Văn A', @QueQuan = N'Hà Nội', @Result = @Result OUTPUT
SELECT @Result
-- trường hợp 2
DECLARE @Result int
EXEC ThemMoiSinhVien @MaSV = 'S001', @TenSV = N'Trần Thanh Tùng', @QueQuan = N'Hà Nội', @Result = @Result OUTPUT
SELECT @Result

-- câu 4a
CREATE TRIGGER KhongChoXoaMonHoc
ON MonHoc
INSTEAD OF DELETE
AS
BEGIN
    PRINT 'Không được phép xóa thông tin trong bảng Môn Học.'
END

--cau 4 b

DELETE FROM MonHoc WHERE MaMon = 'M001'
-- kiêm tra sau khi xóa
select *from MonHoc;

--cau 5a

ALTER TABLE DangKy
ADD ThoiGian int

-- cau5 b

CREATE TRIGGER CapNhatThoiGian
ON DangKy
AFTER INSERT, UPDATE
AS
BEGIN
    UPDATE DK
    SET ThoiGian = DATEDIFF(MONTH, DK.NgayBatDau, DK.NgayKetThuc)
    FROM DangKy DK
    JOIN inserted I ON DK.MaSV = I.MaSV AND DK.MaMon = I.MaMon
END

-- cau 5  c
-- Kiểm tra giá trị trước khi thay đổi
SELECT * FROM DangKy WHERE MaMon = 'M001'

-- Thực hiện câu truy vấn cập nhật
UPDATE DangKy SET NgayKetThuc = '2012/11/28' WHERE MaMon = 'M001'

-- Kiểm tra kết quả sau khi thay đổi
SELECT * FROM DangKy WHERE MaMon = 'M001'